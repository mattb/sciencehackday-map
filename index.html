<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="stylesheet.css" type="text/css" charset="utf-8" />
<style>
path {
  stroke: #ccc;
  stroke-width: 0px;
  fill: white;
}
</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="labeler.js"></script>
<script src="//d3js.org/topojson.v0.min.js"></script>
<script src="//d3js.org/d3.geo.projection.v0.min.js"></script>
<script>
var width = 940,
    height = 725;

var projection = d3.geo.mercator()
    .center([10, 70 ])
    .scale(140)
    .rotate([-180,0]);

var svg = d3.select("body").append("svg")
    .style('background-color', '#d2e8d7')
    .attr("width", width)
    .attr("height", height);

var path = d3.geo.path()
    .projection(projection);

var g = svg.append("g");

// load and display the World
d3.json("world-simp.json", function(error, topology) {

  g.selectAll("path")
    .data(topojson.object(topology, topology.objects.countries)
        .geometries)
    .enter()
    .append("path")
    .attr("d", path)


    // load and display the cities
    d3.json("flags-with-location.js", function(error, data) {
      var markers = [],
      labels = [];
      data.flags.forEach(function(d, i) {
        var c = projection([180 + d.longitude, d.latitude]);
        markers.push({x: c[0] || -10000, y: c[1] || -10000, r: 6});
        labels.push({x: c[0] || -10000, y: c[1] || -10000, name: d.name.toUpperCase(), width: 0.0, height: 0.0})
      });

      g.selectAll("circle")
        .data(markers)
        .enter()
        .append("circle")
        .attr("id", function(d, i) { return "circle-" + i })
        .attr("cx", function(d) {
          return d.x;
        })
      .attr("cy", function(d) {
        return d.y;
      })
      .attr("r", 6)
        .style('opacity', "0.7")
        .style("fill", "#999");

      var labelTexts = g.selectAll("text")
        .data(labels)
        .enter()
        .append("text")
        .attr("text-anchor", function(d) { return (d.position || "start") })
        .text(function(d) { 
          return d.name;
        })
      .style("fill", "black")
        .style("font-size", "12px")
        .style("font-weight", "bold")
        .style("font-family", "blackoutmidnight")
        .style('opacity','0.0')
        .on('mouseover', function(d, i){
          g.selectAll("text").transition().duration(250).style({
            'font-size': '12px', 
            opacity:'0.1'
          });
          d3.select("#line-" + i).transition().style({opacity: '0.9'});

          g.selectAll("circle").transition().style({ opacity:'0.1' });
          d3.select("#circle-" + i).transition().style({opacity: '0.9'});

          d3.select(this).transition().duration(250).style({
            'font-size': '20px', 
            opacity:'1.0'
          });
        })
      .on('mouseout', function(d, i){
        g.selectAll("text").transition().duration(250).style({
          'font-size': '12px', 
          opacity:'0.7'
        });
        g.selectAll("circle").transition().duration(250).style({ opacity:'0.7' });
        d3.select("#line-" + i).transition().style({opacity: '0.0'});
      })

      var index = 0;
      labelTexts.each(function() {
        labels[index].width = this.getBBox().width;
        labels[index].height = this.getBBox().height;
        index += 1;
      });

      setTimeout(function() {
        d3.labeler()
          .label(labels)
          .anchor(markers)
          .width(width)
          .height(height)
          .start(500);
        svg.selectAll("text")
          .transition()
          .style('opacity', '0.8')
          .attr("x", function(d) { return d.x; })
          .attr("y", function(d) { return d.y; })
          .attr("dy", function(d) { return d.height; });

        g.selectAll("line")
          .data(labels)
          .enter()
          .append("line")
          .attr("x1", function(d, i) { return d.x - 2; })
          .attr("y1", function(d, i) { return d.y; })
          .attr("x2", function(d, i) { return markers[i].x })
          .attr("y2", function(d, i) { return markers[i].y })
          .style('opacity', "0.0")
          .attr("stroke", "#999")
          .attr("id", function(d, i) { return "line-" + i })
          .attr("stroke-width", function(d,i) {
            var x1 = d.x;
            var y1 = d.y;
            var x2 = markers[i].x;
            var y2 = markers[i].y;
            if((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1) > 300) {
              return 2;
            } else {
              return 0;
            }
          });

      }, 1);
    });

});

</script>
</body>
</html>
