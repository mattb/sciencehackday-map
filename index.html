<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="stylesheet.css" type="text/css" charset="utf-8" />
<style>
#map-container {
  position: relative;
}
svg {
  position: absolute;
  top: 0;
  left: 0;
  z-index: -1;
}
path {
  stroke: #ccc;
  stroke-width: 0px;
  fill: white;
}
text {
  cursor: pointer;
}

.rollup { 
  fill: #f4f4f4;
}
.rollover-text {
  top: 50%;
  font-size: 16px;
  font-family: Merriweather;
  font-weight: 200;
  margin-left: 20px;
  margin-right: 15px;
}
#map-rollover {
  display: flex;
  flex-direction: row;
  position: absolute;
  align-items: center;
  margin: 20px;
  padding: 10px;
  background-color: #eee;
  left: 0;
  z-index: 1;
  opacity: 0.0;
}
img#rollover-img {
  width: 64px;
  height: 36px;
}

</style>
<body>
  <div id="map-container">
    <div id="map"></div>
    <div id="map-rollover">
      <div>
        <img id="rollover-img" src="http://sciencehackday.org/images/flags/Brazil.png" />
      </div>
      <div class="rollover-text" id="rollover-location">St Petersburg</div>
      <div class="rollover-text" id="rollover-upcoming">Upcoming Event: Stay tuned</div>
      <div class="rollover-text" id="rollover-previous">Previous Event: November 12-13 2016</div>
    </div>
  </div>
<link href='http://fonts.googleapis.com/css?family=Merriweather:400,300,700,900' rel='stylesheet' type='text/css'>
  
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="labeler.js"></script>
<script src="//d3js.org/topojson.v0.min.js"></script>
<script src="//d3js.org/d3.geo.projection.v0.min.js"></script>
<script>
var width = 940,
    height = 560;

var rollover = d3.select("#map-rollover");
rollover
  //.style('opacity', 0.0)
  .style('width', (width - 60) + 'px')
  .style('top', (height - 100) + 'px');

var projection = d3.geo.mercator()
    .center([10, 40 ])
    .scale(140)
    .rotate([-180,0]);

var svg = d3.select("#map").append("svg").classed("map", true)
    .style('background-color', '#d2e8d7')
    .attr("width", width)
    .attr("height", height);

var path = d3.geo.path()
    .projection(projection);

var g = svg.append("g");

// load and display the World
d3.json("world-simp.json", function(error, topology) {

  g.selectAll("path")
    .data(topojson.object(topology, topology.objects.countries)
        .geometries)
    .enter()
    .append("path")
    .attr("d", path)


    // load and display the cities
    d3.json("flags-with-location.js", function(error, data) {
      var markers = [],
      labels = [];
      var seen = {};
      data.flags.forEach(function(d, i) {
        d.flagName = d.country.replace(/\s*/g, "");
        d.startDate = moment(d.start, "DD MMMM YYYY");
        if(!d.startDate.isValid()) d.startDate = moment();
        d.endDate = moment(d.end, "DD MMMM YYYY");
        if(d.startDate.format() == d.endDate.format()) {
          d.startEnd = d.endDate.format("D MMMM YYYY");
        } else if(d.startDate.month() == d.endDate.month()) {
            d.startEnd = d.startDate.format("D") + "-" + d.endDate.format("D MMMM YYYY");
        } else if(d.startDate.year() == d.endDate.year()) {
          d.startEnd = d.startDate.format("D MMMM") + " - " + d.endDate.format("D MMMM YYYY");
        } else {
          d.startEnd = d.startDate.format("D MMMM YYYY") + " - " + d.endDate.format("D MMMM YYYY");
        }
        
        var c = projection([180 + d.longitude, d.latitude]);
        var name = d.transliterated_name || d.name;
        if(!seen[d.name]) {
          markers.push({x: c[0] || -10000, y: c[1] || -10000, r: 6});
          labels.push({x: c[0] || -10000, y: c[1] || -10000, 
            startDate: d.startDate,
            endDate: d.endDate,
            startEnd: d.startEnd,
            url: d.url,
            country: d.flagName,
            label: name + ", " + d.country,
            name: name.toUpperCase(), width: 0.0, height: 0.0})
          seen[d.name] = 1;
        }
      });

      g.selectAll("circle")
        .data(markers)
        .enter()
        .append("circle")
        .attr("id", function(d, i) { return "circle-" + i })
        .attr("cx", function(d) {
          return d.x;
        })
      .attr("cy", function(d) {
        return d.y;
      })
      .attr("r", 6)
        .style('opacity', "0.7")
        .style("fill", "#999");

      var labelTexts = g.selectAll("text")
        .data(labels)
        .enter()
        .append("text")
        .classed("map-text", true)
        .attr("text-anchor", function(d) { return (d.position || "start") })
        .text(function(d) { 
          return d.name;
        })
      .on('click', function(d) {
        window.location = d.url;
      })
      .style("fill", "black")
        .style("font-size", "12px")
        .style("font-weight", "bold")
        .style("font-family", "blackoutmidnight")
        .style('opacity','0.0')
        .on('mouseover', function(d, i){
          d3.select("#rollover-img").attr("src", "http://sciencehackday.org/images/flags/" + d.country + ".png");
          d3.select("#rollover-location").html(d.label);
          if(d.startDate.isAfter()) {
            d3.select("#rollover-upcoming").html("Upcoming: " + d.startEnd);
          } else {
            d3.select("#rollover-upcoming").html("Upcoming: Stay tuned");
          }
          d3.select("#rollover-previous").html("");
          rollover.transition().duration(250).style("opacity", 1.0);
          g.selectAll("text").transition().duration(250).style({
            'font-size': '12px', 
            opacity:'0.1'
          });
          d3.select("#line-" + i).transition().style({opacity: '0.9'});

          g.selectAll("circle").transition().style({ opacity:'0.1' });
          d3.select("#circle-" + i).transition().style({opacity: '0.9'});

          d3.select(this).transition().duration(250).style({
            'font-size': '20px', 
            opacity:'1.0'
          });
        })
      .on('mouseout', function(d, i){
        rollover.transition().duration(250).style("opacity", 0.0);
        g.selectAll("text").transition().duration(250).style({
          'font-size': '12px', 
          opacity:'0.7'
        });
        g.selectAll("circle").transition().duration(250).style({ opacity:'0.7' });
        d3.select("#line-" + i).transition().style({opacity: '0.0'});
      })

      var index = 0;
      labelTexts.each(function() {
        labels[index].width = this.getBBox().width;
        labels[index].height = this.getBBox().height;
        index += 1;
      });

      setTimeout(function() {
        d3.labeler()
          .label(labels)
          .anchor(markers)
          .width(width)
          .height(height)
          .start(500);
        svg.selectAll("text.map-text")
          .transition()
          .style('opacity', '0.8')
          .attr("x", function(d) { return d.x; })
          .attr("y", function(d) { return d.y; })
          .attr("dy", function(d) { return d.height; });

        g.selectAll("line")
          .data(labels)
          .enter()
          .append("line")
          .attr("x1", function(d, i) { return d.x - 2; })
          .attr("y1", function(d, i) { return d.y; })
          .attr("x2", function(d, i) { return markers[i].x })
          .attr("y2", function(d, i) { return markers[i].y })
          .style('opacity', "0.0")
          .attr("stroke", "#999")
          .attr("id", function(d, i) { return "line-" + i })
          .attr("stroke-width", function(d,i) {
            var x1 = d.x;
            var y1 = d.y;
            var x2 = markers[i].x;
            var y2 = markers[i].y;
            if((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1) > 300) {
              return 2;
            } else {
              return 0;
            }
          });

      }, 1);
    });

});

</script>
</body>
</html>
